<!DOCTYPE html>

<html lang="en">

<head>
  
  <title>AJAX基本语法 - Hexo</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

  <link rel="shortcut icon" href="/favicon.ico" type="image/png" />
  <meta name="description" content="AJAX（Asynchronous JavaScript and XML），是指使用JavaScript和XML进行异步刷新局部网页的技术。不是一种新的编程语言，是基于JavaScript、XML、HTML、CSS新用法。它使我们可以通过 JavaScript 直接获取服务端最新的内容而不必重新加载页面。让Web更能接近桌面应用的用户体验。 说白了，AJAX 就是浏览器提供的一套 API，可以通过">
<meta property="og:type" content="article">
<meta property="og:title" content="AJAX基本语法">
<meta property="og:url" content="http://example.com/2019/12/11/AJAX%E5%85%B7%E4%BD%93%E7%94%A8%E6%B3%95/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="AJAX（Asynchronous JavaScript and XML），是指使用JavaScript和XML进行异步刷新局部网页的技术。不是一种新的编程语言，是基于JavaScript、XML、HTML、CSS新用法。它使我们可以通过 JavaScript 直接获取服务端最新的内容而不必重新加载页面。让Web更能接近桌面应用的用户体验。 说白了，AJAX 就是浏览器提供的一套 API，可以通过">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-12-11T09:54:11.000Z">
<meta property="article:modified_time" content="2021-03-11T08:15:03.195Z">
<meta property="article:author" content="BlackGarland">
<meta name="twitter:card" content="summary">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,gh/theme-nexmoe/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,gh/theme-nexmoe/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css?v=233" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1615530498376">
<meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-coy.css" type="text/css"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="BlackGarland" class="mdui-btn mdui-btn-icon"><img src="http://pic1.win4000.com/wallpaper/8/597948c99648d.jpg" alt="BlackGarland"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="BlackGarland">
            <img src="http://pic1.win4000.com/wallpaper/8/597948c99648d.jpg" alt="BlackGarland" alt="BlackGarland">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>7</div>
        <div><span>Tags</span>0</div>
        <div><span>Categories</span>0</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
            <label><input id="search_value" name="q" type="search" placeholder="Search"></label>
        </form>
    </div>
</div>
  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=5CfKHun" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/160195236/" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/nexmoe/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  

  
  
  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 BlackGarland
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
  
      <div class="nexmoe-post-cover" style="padding-bottom: 62.5%;"> 
          <img data-src="https://pic.netbian.com/uploads/allimg/180315/110404-1521083044b19d.jpg" data-sizes="auto" alt="AJAX基本语法" class="lazyload">
          <h1>AJAX基本语法</h1>
      </div>
  
  
  <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2019年12月11日</a>
    <a><i class="nexmoefont icon-areachart"></i>0 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 1 分钟</a>
</div>

  <div class="nexmoe-post-right">
    
  </div>

  <article>
    <p>AJAX（Asynchronous JavaScript and XML），是指使用JavaScript和XML进行<strong>异步刷新局部网页的技术</strong>。不是一种新的编程语言，是基于JavaScript、XML、HTML、CSS新用法。它使我们可以通过 JavaScript 直接获取服务端最新的内容而不必重新加载页面。让Web更能接近桌面应用的用户体验。</p>
<p>说白了，AJAX 就是浏览器提供的一套 API，可以通过 JavaScript 调用，从而实现通过代码控制请求与响应。实现网络编程。</p>
<a id="more"></a>
<p>AJAX（Asynchronous JavaScript and XML），是指使用JavaScript和XML进行<strong>异步刷新局部网页的技术</strong>。不是一种新的编程语言，是基于JavaScript、XML、HTML、CSS新用法。它使我们可以通过 JavaScript 直接获取服务端最新的内容而不必重新加载页面。让Web更能接近桌面应用的用户体验。</p>
<p>说白了，AJAX 就是浏览器提供的一套 API，可以通过 JavaScript 调用，从而实现通过代码控制请求与响应。实现网络编程。</p>
<h2 id="1-具体用法">1.具体用法</h2>
<h3 id="1-1-GET-请求返回用户数据">1.1. GET 请求返回用户数据</h3>
<pre><code>通常在一次 GET 请求过程中，参数传递都是通过 URL 地址中的 ? 参数传递。
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript"><ul id="list"></ul>

<script>
var listElement = document.getElementById('list')
// 发送请求获取列表数据呈现在页面
// =======================================
var xhr = new XMLHttpRequest();
xhr.open('GET', 'http://localhost:3000/getdata');
xhr.send();
xhr.onreadystatechange = function () &#123;
    if (this.readyState !== 4) return
    var data = JSON.parse(this.responseText)
    // data => 数据
    for (var i = 0; i < data.length; i++) &#123;
        var liElement = document.createElement('li')
        liElement.innerHTML = data[i].name
        liElement.id = data[i].id
        listElement.appendChild(liElement)
        liElement.addEventListener('click', function () &#123;
            // TODO: 通过AJAX操作获取服务端对应数据的信息
            // 如何获取当前被点击元素对应的数据的ID
            // console.log(this.id)
            var xhr1 = new XMLHttpRequest()
            xhr1.open('GET', 'http://localhost:3000/getdata?id=' + this.id)
            xhr1.send()
            xhr1.onreadystatechange = function () &#123;
                if (this.readyState !== 4) return
                var obj = JSON.parse(this.responseText)
                alert(obj.age)
            &#125;
        &#125;)
    &#125;
&#125;



//server.js
var express = require('express');
var app = express();
var data = [&#123;id:1,name:"张三",age:18&#125;,&#123;id:2,name:"李四",age:20&#125;,&#123;id:3,name:"二傻子",age:19&#125;,&#123;id:4,name:"三愣子",age:28&#125;];
app.get('/getdata', function(req, res) &#123;
	res.header("Content-Type", "application/json; charset=utf-8");
	var query = req.query;
	if(query.id)&#123;
		//console.log(query);
		var id = query.id;
		var find = false;
		data.forEach(function(ele,i)&#123;
			if(ele.id == id)&#123;
				find = true;
				res.end( JSON.stringify( data[i] ));
			&#125;
		&#125;)
		if(find == false)&#123;
			res.end( JSON.stringify( data ));
		&#125;
	&#125;
	else&#123;
		res.end( JSON.stringify( data ));
	&#125;
&#125;);

app.listen(3000);
console.log('Listening on port 3000...');
</code></pre>
<h3 id="1-2-POST-请求登录案例">1.2. POST 请求登录案例</h3>
<pre><code>POST 请求过程中，都是采用请求体承载需要提交的数据。
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">//login.html
<style>
#loading &#123;
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    opacity: .5;
    text-align: center;
    line-height: 300px;
&#125;

#loading::after &#123;
    content: '加载中...';
    color : #fff;
&#125;
</style>

<body>
  <div id="loading"></div>
  <table border="1">
    <tr>
      <td>用户名</td>
      <td><input type="text" id="username"></td>
    </tr>
    <tr>
      <td>密码</td>
      <td><input type="password" id="password"></td>
    </tr>
    <tr>
      <td></td>
      <td><button id="btn">登录</button></td>
    </tr>
  </table>
</body>
    
<script>
// 找一个合适的时机，做一件合适的事情
var btn = document.getElementById('btn')
// 1. 获取界面上的元素 value
var txtUsername = document.getElementById('username')
var txtPassword = document.getElementById('password')
var loading = document.getElementById('loading')

btn.onclick = function () &#123;
    loading.style.display = 'block'
    var username = txtUsername.value
    var password = txtPassword.value
    // 2. 通过 XHR 发送一个 POST 请求
    var xhr = new XMLHttpRequest()
    xhr.open('POST', 'http://localhost:3000/dologin')
    // 设置请求的content-type
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
    // xhr.send('username=' + username + '&password=' + password)
    xhr.send(`username=$&#123;username&#125;&password=$&#123;password&#125;`)
    // 3. 根据服务端的反馈 作出界面提示
    xhr.onreadystatechange = function () &#123;
        if (this.readyState !== 4) return
        console.log(this.responseText)
        loading.style.display = 'none'
    &#125;
&#125;
</script>


//server.js
var express = require('express');
var app = express();
const bodyParser = require('body-parser')
app.use(bodyParser.urlencoded(&#123; extended: false &#125;));

app.use(express.static('views'));

app.post("/dologin",function(req,res)&#123;
	 let data = req.body;
	 console.log(data);
	 if(!data.username || !data.password)&#123;
	 	console.log("111");
	 	res.end("请输入用户密码");
	 &#125;
	 else&#123;
	 	console.log("222");
	 	if (data.username === 'admin' && data.password === '123') &#123;
		  res.end('恭喜你');
		&#125;
		console.log("333");
	    res.end('用户名或者密码错误');
	 &#125;
	 
&#125;)

app.listen(3000);
console.log('Listening on port 3000...');
</code></pre>
<h3 id="1-3-同步与异步">1.3. 同步与异步</h3>
<pre><code>xhr.open() 方法第三个参数要求传入的是一个 bool 值，其作用就是设置此次请求是否采用异步方式执行，默认为 true ，如果需要同步执行可以通过传递 false 实现：
</code></pre>
<pre class=" language-language-php"><code class="language-language-php">console.log('before ajax')
var xhr = new XMLHttpRequest()
// 默认第三个参数为 true 意味着采用异步方式执行
xhr.open('GET', 'http://localhost:3000/getTime', true)
xhr.send(null)
xhr.onreadystatechange = function () &#123;
	if (this.readyState === 4) &#123;
		// 这里的代码最后执行
		console.log('request done')
	&#125;
&#125;
console.log('after ajax');
</code></pre>
<pre><code>如果采用同步方式执行，则代码会卡死在 xhr.send() 这一步：
</code></pre>
<pre class=" language-language-php"><code class="language-language-php">console.log('before ajax')
var xhr = new XMLHttpRequest()
// 同步方式
xhr.open('GET', 'http://localhost:3000/getTime', false)
// 同步方式 执行需要 先注册事件再调用 send，否则 readystatechange 无法触发
xhr.onreadystatechange = function () &#123;
	if (this.readyState === 4) &#123;
		// 这里的代码最后执行
		console.log('request done')
	&#125;
&#125;
xhr.send(null)
console.log('after ajax')
    
//如果是同步请求，一定在发送请求 send() 之前注册 readystatechange 
</code></pre>
<h3 id="1-4-响应数据格式">1.4. 响应数据格式</h3>
<pre><code>提问：如果希望服务端返回一个复杂数据，该如何处理？
关心的问题就是服务端发出何种格式的数据，这种格式如何在客户端用 JavaScript 解析。
</code></pre>
<h4 id="1-4-1-XML介绍">1.4.1. XML介绍</h4>
<pre><code>XML是一种数据格式，xml文件以xml后缀名结尾。xml文件需要使用xml解析器去解析。浏览器内置了xml解析器。(XML这种数据格式目前使用没有JSON多)

XML的组成：标签、属性、注释、文档声明
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">//1.XML标签
<student>AA</student>  开始标签  标签体内容  结束标签

1）<student/> 或 <student></student> 空标签。没有标签体内容
2）xml标签名称区分大小写。
3）xml标签一定要正确配对。
4）xml标签名中间不能使用空格
5）xml标签名不能以数字开头
6）注意： 在一个xml文档中，有且仅有一个根标签

//2.属性
<student name="eric">student</student>
1）属性值必须以引号包含，可以是单引号也可以双引号，但是不能单双引号混用！！！
2）一个标签内可以有多个属性，但不能出现重复的属性名！！！

//3.注释
  <!--  xml注释 -->

//4.文档声明
<?xml version="1.0" encoding="utf-8"?>
1) version: xml的版本号
2) encoding： 解析xml文件时查询的码表（解码过程时查询的码表）
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">//使用xml设计一个通讯录
<?xml version="1.0" encoding="utf-8"?>
<contact>
	<person id="100">
		 <name>张三</name>
		 <age>18</age>
		 <phone>12345678</phone>
		 <email>12453@qq.com</email>
	</person>
	<person id="101">
		 <name>李四</name>
		 <age>20</age>
		 <phone>22345678</phone>
		 <email>34453@qq.com</email>
	</person>
</contact>
</code></pre>
<h4 id="1-4-2-返回XML">1.4.2 返回XML</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript"><script>
	var xhr = new XMLHttpRequest()
	xhr.open('GET', 'http://localhost:3000/getXML')
	xhr.send()
	xhr.onreadystatechange = function () &#123;
    	if (this.readyState !== 4) return
        // this.responseXML 专门用于获取服务端返回的 XML 数据，操作方式就是通过 DOM 的方式操作
        // 但是需要服务端响应头中的 Content-Type 必须是 application/xml
        console.log(this.responseXML.documentElement.children[0].innerHTML)
        console.log(this.responseXML.documentElement.getElementsByTagName('name')[0])
    &#125;
</script>
  
//server.js
app.get("/getXML",function(req,res)&#123;
	 res.header("Content-Type","application/xml");

	 var xml =  '<?xml version="1.1" encoding="utf-8"?>';
	 xml += '<person>';
	 xml += '<name>羊杨</name>';
	 xml += '<age>16</age>';
	 xml += '<gender>男</gender>';
	 xml += '</person>';
    
	 res.end(xml);
&#125;)
</code></pre>
<h4 id="3-4-3-返回JSON">3.4.3.返回JSON</h4>
<pre><code>JSON是一种数据格式，类似于 JavaScript 字面量方式
服务端采用 JSON 格式返回数据，客户端按照 JSON 格式解析数据。
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript"><body>
  <table>
    <tbody id="content"></tbody>
  </table>
  <script>
    var xhr = new XMLHttpRequest()
    xhr.open('GET', 'http://localhost:3000/getJson')
    xhr.send()
    xhr.onreadystatechange = function () &#123;
      if (this.readyState !== 4) return
      var res = JSON.parse(this.responseText)
      // res => 服务端返回的数据
      var data = res.data
      for (var i = 0; i < data.length; i++) &#123;
        // 先创建行
        // 再创建列
        // 再将列添加到行
        // 再将行添加到tbody
        // console.log(data[i])
        var tr = document.createElement('tr')
        tr.innerHTML = '<td>' + data[i].id + '</td><td></td><td></td><td></td><td></td><td></td>'
      &#125;
    &#125;
  </script>
</body>


//server.js
app.get("/getJson",function(req,res)&#123;
	res.header("Content-Type", "application/json; charset=utf-8");
	var data =  &#123;
			"success": true,
			"data": [&#123;
				"0": "7",
				"id": "7",
				"1": "哈哈",
				"author": "哈哈",
				"2": "hh@gmail.com",
				"email": "hh@gmail.com",
			&#125;, &#123;
				"0": "6",
				"id": "6",
				"1": "小右",
				"author": "小右",
				"2": "www@gmail.com",
				"email": "www@gmail.com",
			&#125;, &#123;
				"0": "4",
				"id": "4",
				"1": "汪磊",
				"author": "汪磊",
				"2": "www@gmail.com",
				"email": "www@gmail.com",
			&#125;],
			"total_count": 3
	&#125;
	res.end( JSON.stringify(data));
&#125;)

</code></pre>
<h4 id="1-4-4-模板引擎处理响应数据渲染">1.4.4 模板引擎处理响应数据渲染</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript"><body>
  <table id="demo"></table>
  <script id="tmpl" type="text/x-art-template">
    &#123;&#123;each comments&#125;&#125;
    <!-- each 内部 $value 拿到的是当前被遍历的那个元素 -->
    <tr>
      <td>&#123;&#123;$value.author&#125;&#125;</td>
      <td>&#123;&#123;$value.content&#125;&#125;</td>
    </tr>
    &#123;&#123;/each&#125;&#125;
  </script>
      
  <script src="template-web.js"></script>
  <script>
    var xhr = new XMLHttpRequest()
    xhr.open('GET', 'http://localhost:3000/getJson')
    xhr.send()
    xhr.onreadystatechange = function () &#123;
      if (this.readyState !== 4) return
      var res = JSON.parse(this.responseText)

      // 模板所需数据
      var context = &#123; comments: res.data &#125;
      // 借助模板引擎的API 渲染数据
      var html = template('tmpl', context)
      console.log(html)

      document.getElementById('demo').innerHTML = html
    &#125;
  </script>
</body>


//server.js
app.get("/getJson",function(req,res)&#123;
	res.header("Content-Type", "application/json; charset=utf-8");
	var data =  &#123;
			"success": true,
			"data": [&#123;
				"0": "7",
				"id": "7",
				"1": "哈哈",
				"author": "哈哈",
				"2": "hh@gmail.com",
				"email": "hh@gmail.com",
			&#125;, &#123;
				"0": "6",
				"id": "6",
				"1": "小右",
				"author": "小右",
				"2": "www@gmail.com",
				"email": "www@gmail.com",
			&#125;, &#123;
				"0": "4",
				"id": "4",
				"1": "汪磊",
				"author": "汪磊",
				"2": "www@gmail.com",
				"email": "www@gmail.com",
			&#125;],
			"total_count": 3
	&#125;
	res.end( JSON.stringify(data));
&#125;)

</code></pre>
<h4 id="1-4-5-发送application-json数据">1.4.5 发送application/json数据</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript">$("#btn4").click(function()&#123;
		$.ajax(&#123;
		    url: 'http://localhost:8000/testJSONData',
		    //请求方式
		    type: 'post',
		    //指定向服务器提交的数据是JSON格式的数据
		    contentType: "application/json; charset=utf-8",
		    //向服务器提交的具体数据
        	data: JSON.stringify([&#123;name:"zhangsan"&#125;,&#123;name:"lisi "&#125;]),
		    //请求成功的回调
		    success: function (res) &#123;
		       console.log(res);
		    &#125;
		&#125;)
	&#125;)



//配置bodyParser中间件  解析application/x-www-form-urlencoded 这种post请求方式提交的数据
app.use(bodyParser.urlencoded(&#123; extended: false &#125;))
//配置bodyParser中间件  解析application/json; charset=utf-8 这种post请求方式提交的数据
app.use(bodyParser.json()); 
app.post("/testJSONData",(req,res)=>&#123;
	console.log(req.body); 
	res.send("xxxx");
&#125;)
</code></pre>
<h2 id="2-封装">2.封装</h2>
<h3 id="2-1-回调函数">2.1 回调函数</h3>
<pre><code>回调函数具体的定义为：函数A作为参数(函数引用)传递到另一个函数B中，并且这个函数B执行函数A。我们就说函数A叫做回调函数。如果没有名称(函数表达式)，就叫做匿名回调函数。

因此callback 不一定用于异步，一般同步(阻塞)的场景下也经常用到回调，比如要求执行某些操作后执行回调函数。
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">//同步回调
var callback = function(arg3) &#123;
    console.log('callback Totle is:' + arg3)
&#125;

function fn(arg1, arg2, cb) &#123;
    var Total = arg1 + arg2;
    cb(Total);
    console.log('mainFunction Totle is:' + Total)
&#125;

fn(2, 2, callback)   

//异步回调
function f2() &#123;
    console.log('f2 finished') 
&#125;

function f1(cb) &#123;
    setTimeout(cb,1000)        //用setTimeout()模拟耗时操作
    console.log('f1 finished')
&#125;

f1(f2);  
</code></pre>
<h3 id="2-2-AJAX-请求封装">2.2. AJAX 请求封装</h3>
<pre class=" language-language-javascript"><code class="language-language-javascript">/**
* 发送一个 AJAX 请求
* @param &#123;String&#125; method 请求方法
* @param &#123;String&#125; url 请求地址
* @param &#123;Object&#125; params 请求参数
* @param &#123;Function&#125; done 请求完成过后需要做的事情（委托/回调）
*/
function ajax (method, url, params, done) &#123;
    method = method.toUpperCase()
    var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP')
    if (typeof params === 'object') &#123;
        var tempArr = []
        for (var key in params) &#123;
            var value = params[key]
            tempArr.push(key + '=' + value)
        &#125;
        params = tempArr.join('&')
    &#125;
    if (method === 'GET') &#123;
        url += '?' + params
    &#125;
    xhr.open(method, url, true)
    var data = null
    if (method === 'POST') &#123;
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        data = params
    &#125;
    xhr.onreadystatechange = function () &#123;
        if (this.readyState !== 4) return
        // 不应该在封装的函数中主观的处理响应结果
        // console.log(this.responseText)
        // 你说我太主观，那么你告诉我应该做什么
        done(this.responseText)
    &#125;
    xhr.send(data)
&#125;


var onDone = function (res) &#123;
    console.log(res)
    console.log('做完了')
&#125;
ajax('get', 'http://localhost:3000/getTime', &#123;&#125;, onDone)


//time.php
<?php
echo time();
</code></pre>
<h3 id="2-3-jQuery-中的-AJAX">2.3. jQuery 中的 AJAX</h3>
<pre><code>jQuery 中有一套专门针对 AJAX 的封装，功能十分完善
参考：
http://www.jquery123.com/category/ajax/
http://www.w3school.com.cn/jquery/jquery_ref_ajax.asp
</code></pre>
<h4 id="2-3-1-ajax">2.3.1. $.ajax</h4>
<pre><code>常用选项参数介绍：
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">url：请求地址
type：请求方法，默认为 get
dataType：服务端响应数据类型
contentType：请求体内容类型，默认 application/x-www-form-urlencoded
data：需要传递到服务端的数据，如果 GET 则通过 URL 传递，如果 POST 则通过请求体传递
timeout：请求超时时间

beforeSend：请求发起之前触发
success：请求成功之后触发（响应状态码 200）
error：请求失败触发
complete：请求完成触发（不管成功与否）
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">// 1.最基础的调用
$.ajax('http://localhost:3000/getTime', &#123;
    type: 'post', // method 请求方法
    success: function (res) &#123;
        // res => 拿到的只是响应体
        console.log(res)
    &#125;
&#125;)


$.ajax(&#123;
    url: 'http://localhost:3000/getTime',
    type: 'post',
    // 用于提交到服务端的参数，
    // 如果是 GET 请求就通过 url 传递
    // 如果是 POST 请求就通过请求体传递
    data: &#123; id: 1, name: '张三' &#125;,
    success: function (res) &#123;
        console.log(res)
    &#125;
&#125;)

//服务端设置content-type
$.ajax(&#123;
    url: 'http://localhost:3000/testJson',
    type: 'get',
    success: function (res) &#123;
        // res 会自动根据服务端响应的 content-type 自动转换为对象
        // 这是 jquery 内部实现的
        console.log(res)
    &#125;
&#125;)

//服务端不设置content-type，客户端设置dataType
$.ajax(&#123;
    url: 'http://localhost:3000/testJson',
    type: 'get',
    // 设置的是请求参数
    data: &#123; id: 1, name: '张三' &#125;,
    // 内部会调用JSON.parse()将服务端响应的数据转换为json对象
    dataType: 'json',
    success: function (res) &#123;
        console.log(res)
    &#125;
&#125;)


//server.js
app.get("/testJson",function(req,res)&#123;
	res.header("Content-Type", "application/json; charset=utf-8");
	var data =  &#123;
			name:"张三",
			age:18
	&#125;
	res.end( JSON.stringify(data));
&#125;)
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript">//关于dataType
//1.通过dataType选项还可以指定其他不同数据处理方式。可以指定 html、json、jsonp、script或者text。

//2.其中，text和xml类型返回的数据不会经过处理。数据仅仅简单的将XMLHttpRequest的responseText或responseXML属性传递给success回调函数，

//3.如果指定为html类型，返回HTML文本，包含的script标签会在插入DOM时执行

//4.如果指定script类型的话，把响应的结果当作JavaScript 执行，并将其当作纯文本返回

//5.如果指定为json类型，则会把获取到的数据作为一个JavaScript对象来解析，并且把构建好的对象作为结果返回。为了实现这个目的，他首先尝试使用JSON.parse()。如果浏览器不支持，则使用一个函数来构建。JSON数据是一种能很方便通过JavaScript解析的结构化数据。

//6.如果获取的数据文件存放在远程服务器上（域名不同，也就是跨域获取数据），则需要使用jsonp类型。会自动在所请求的URL最后添加"?callback=?"。服务器端应当在JSON数据前加上回调函数名，以便完成一个有效的JSONP请求。

'注意：我们必须确保网页服务器报告的MIME类型与我们选择的dataType所匹配。比如说，dataType为XML的话，服务器端就必须声明 text/xml 或者 application/xml 来获得一致的结果'
</code></pre>
<h4 id="2-3-2-请求回调">2.3.2. 请求回调</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript">$.ajax(&#123;
    url: 'http://localhost:3000/testTime',
    type: 'get',
    beforeSend: function (xhr) &#123;
        // 在所有发送请求的操作（open, send）之前执行
        console.log('beforeSend', xhr)
    &#125;,
    success: function (res) &#123;
        // 只有请求成功（状态码为200）才会执行这个函数
        console.log(res)
    &#125;,
    error: function (xhr) &#123;
        // 隐藏 loading
        // 只有请求不正常（状态码不为200）才会执行
        console.log('error', xhr)
    &#125;,
    complete: function (xhr) &#123;
        // 不管是成功还是失败都是完成，都会执行这个 complete 函数
        console.log('complete', xhr)
    &#125;
&#125;)
</code></pre>
<h4 id="2-3-3-全局事件处理">2.3.3. 全局事件处理</h4>
<pre><code>http://www.jquery123.com/category/ajax/global-ajax-event-handlers/
</code></pre>
<pre class=" language-language-php"><code class="language-language-php">.ajaxStart(function()&#123;&#125;)
.ajaxStop(function()&#123;&#125;)
</code></pre>
<pre class=" language-language-javascript"><code class="language-language-javascript"><style>
    .loading &#123;
        display: none;
        position: fixed;
    &#125;
</style>

<div class="loading">正在玩命加载中...</div>
<button id="btn">请求</button>
<script src="jquery.js"></script>
<script>
	$(document).ajaxStart(function () &#123;
        // 只要有 ajax 请求发生 就会执行
        $('.loading').fadeIn()
        // 显示加载提示
        console.log('注意即将要开始请求了')
	&#125;).ajaxStop(function () &#123;
        // 只要有 ajax 请求结束 就会执行
        $('.loading').fadeOut()
        // 结束提示
        console.log('请求结束了')
	&#125;)
    $('#btn').on('click', function () &#123;
        $.get('http://localhost:3000/getTime')
    &#125;)
</script>
</code></pre>
<h4 id="2-3-4-nprogress的使用">2.3.4 nprogress的使用</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript"><link rel="stylesheet" href="../nprogress.css"> 
<script src="../nprogress.js"></script>
<script src="../jquery.js"></script>

<button id="btn">请求</button>

$(document).ajaxStart(function () &#123;
    NProgress.start()
&#125;).ajaxStop(function () &#123;
    NProgress.done()
&#125;)

$("#btn").click(function()&#123;
    $.ajax(&#123;
        url: 'http://localhost:8000/getData',
        //请求方式
        type: 'get',
        //请求成功的回调
        success: function (res) &#123;
            console.log(res);
        &#125;
    &#125;)
&#125;)
</code></pre>
<h4 id="2-3-6-案例-省市联动">2.3.6 案例:省市联动</h4>
<pre class=" language-language-javascript"><code class="language-language-javascript">##1 select.html
<div id="container">
    <label>
        省：<select id="province">
        <option>请选择省...</option>
        </select>
    </label>
    <label>
        市：<select id="city">
        <option>请选择市...</option>
        </select>
    </label>
    <label>
        县：<select id="county">
        <option>请选择县...</option>
        </select>
    </label>
</div>

<style type="text/css">
    #container&#123;
        width: 500px;
        min-height: 300px;
        background-color: lightgreen;
        margin: auto;
        text-align: center;
        padding: 10px;
    &#125;
</style>
    
    
//发送请求获取所有省份的数据
$.ajax(&#123;
    type:"get",
    url:"http://localhost:8000/getProvinces",
    success:function(res)&#123;
        //console.log(res);
        var html = template("provinceTemplate",&#123;provinces:res&#125;)
        $("#province").append(html);
    &#125;
&#125;)

//该事件是需要点击鼠标之后才会触发的
$("#province").change(function()&#123;
    var selid = $(this).val();
    $.ajax(&#123;
        type:"get",
        url:"http://localhost:8000/getCities/"+selid,
        success:function(res)&#123;
            //console.log(res);
            $("#city option:not(:first)").remove();
            var html = template("cityTemplate",&#123;cities:res&#125;)
            $("#city").append(html);
        &#125;
    &#125;)
&#125;)


//给city绑定change事件
$("#city").change(function()&#123;
    console.log($(this).val());
    var selid = $(this).val();
    $.ajax(&#123;
        type:"get",
        url:"http://localhost:8000/getCountries/"+selid,
        success:function(res)&#123;
            console.log(res);
            $("#country option:not(:first)").remove();
            var html = template("countryTemplate",&#123;countries:res&#125;)
            $("#country").append(html);
        &#125;
    &#125;)
&#125;)

##2 server.js
let express = require("express");
let app = express();
let db = require("./views/selectdata");
//let bodyParser = require("body-parser");
app.use(express.static("./views"));

//配置bodyParser中间件  解析application/x-www-form-urlencoded 这种post请求方式提交的数据
//app.use(bodyParser.urlencoded(&#123; extended: false &#125;))
//配置bodyParser中间件  解析application/json; charset=utf-8 这种post请求方式提交的数据
//app.use(bodyParser.json());

//console.log(db.cityJson);
//console.log(db.countyJson);


//返回所有省份的数据
app.get("/getProvinces",(req,res)=>&#123;
	res.header("content-type", "application/json;charset=utf-8");
	res.send(JSON.stringify(db.provinceJson))
&#125;)

app.get("/getCities/:id",(req,res)=>&#123;
	res.header("content-type", "application/json;charset=utf-8");
	//获取省份的id信息
	let id = req.params["id"];
	//所有的城市信息
	let cities = db.cityJson;
	//要返回的城市的数组
	let currentCities = []
	for (var i = 0; i < cities.length; i++) &#123;
		//是直辖市
		if (cities[i].id == id) &#123;
			currentCities.push(cities[i]);
			break;
		&#125;
		//不是直辖市
		else if(cities[i].parent == id)&#123;
			currentCities.push(cities[i]);
		&#125;
	&#125;
	//将currentCities城市信息返回
	res.send(JSON.stringify(currentCities));
&#125;)


app.get("/getCountries/:id",(req,res)=>&#123;
	res.header("content-type", "application/json;charset=utf-8");
	let id = req.params["id"];
	let countries = db.countyJson;
	let currentCountries = []
	for (var i = 0; i < countries.length; i++) &#123;
		if(countries[i].parent == id)&#123;
			currentCountries.push(countries[i]);
		&#125;
	&#125;
	res.send(JSON.stringify(currentCountries));
&#125;)

app.listen(8000,()=>&#123;
	console.log("running....")
&#125;)

</code></pre>
<h2 id=""></h2>

  </article>

  
    
  <div class="nexmoe-post-copyright">
    <strong>Author：</strong>BlackGarland<br>
    <strong>Link：</strong><a href="http://example.com/2019/12/11/AJAX%E5%85%B7%E4%BD%93%E7%94%A8%E6%B3%95/" title="http:&#x2F;&#x2F;example.com&#x2F;2019&#x2F;12&#x2F;11&#x2F;AJAX%E5%85%B7%E4%BD%93%E7%94%A8%E6%B3%95&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;example.com&#x2F;2019&#x2F;12&#x2F;11&#x2F;AJAX%E5%85%B7%E4%BD%93%E7%94%A8%E6%B3%95&#x2F;</a><br>
    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
    
</div>

  <div class="nexmoe-post-footer">
    <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
  </div>
</div>
        <div class="nexmoe-post-right">
          <div class="nexmoe-fixed">
            <div class="nexmoe-tool">
              <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
            </div>
          </div>
        </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>
 <script src="/js/app.js?v=1615530498377"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru02.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":false},"rect":"opacity:0.7","log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
